"use client";

import React from "react";
import type { SpriteExpression } from "@/data/vnBeats";

// ─── カラーパレット ───────────────────────────────────────────
const C = {
  _: "transparent",  // 透明
  W: "#FFFFFF",      // 白（白衣）
  w: "#F0F0F0",      // 白衣シャドウ
  S: "#F5C89A",      // 肌色
  s: "#E0A870",      // 肌シャドウ
  H: "#3A2010",      // 髪（濃い茶）
  h: "#5A3820",      // 髪ハイライト
  E: "#1A1A1A",      // 目・輪郭
  R: "#CC0000",      // 赤（怒り頬・赤帯）
  r: "#FF6060",      // 薄赤
  B: "#8B6040",      // カウンター茶色
} as const;

type ColorKey = keyof typeof C;

const PIXEL = 8;    // 1グリッド = 8px
const COLS  = 20;
const ROWS  = 32;

// ─── ピクセルグリッド描画 ─────────────────────────────────────
function renderGrid(rows: ColorKey[][]): React.ReactNode[] {
  const rects: React.ReactNode[] = [];
  rows.forEach((row, y) => {
    row.forEach((key, x) => {
      if (key === "_") return;
      rects.push(
        <rect
          key={`${x}-${y}`}
          x={x * PIXEL}
          y={y * PIXEL}
          width={PIXEL}
          height={PIXEL}
          fill={C[key]}
          shapeRendering="crispEdges"
        />
      );
    });
  });
  return rects;
}

// ─── ベースボディ（全表情共通：白衣・首・髪ベース） ─────────────
// 行0-31、列0-19 (20×32グリッド)
const BASE_ROWS: ColorKey[][] = [
  // 0: 頭上の空白
  ["_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_"],
  // 1: 髪
  ["_","_","_","_","_","H","H","H","H","H","H","H","H","H","H","_","_","_","_","_"],
  // 2: 髪
  ["_","_","_","_","H","H","H","H","H","H","H","H","H","H","H","H","_","_","_","_"],
  // 3: 髪＋額
  ["_","_","_","H","H","h","H","H","H","H","H","H","H","h","H","H","H","_","_","_"],
  // 4: 髪＋額
  ["_","_","H","H","S","S","S","S","S","S","S","S","S","S","S","S","H","H","_","_"],
  // 5: 顔上部（眉行は表情で差し替え）
  ["_","_","H","S","S","S","S","S","S","S","S","S","S","S","S","S","S","H","_","_"],
  // 6: 眉・目上（表情差し替え行）
  ["_","_","S","S","E","E","S","S","S","S","S","S","S","S","E","E","S","S","_","_"],
  // 7: 目（表情差し替え行）
  ["_","_","S","S","E","E","S","S","S","S","S","S","S","S","E","E","S","S","_","_"],
  // 8: 目下
  ["_","_","S","S","S","S","S","S","S","S","S","S","S","S","S","S","S","S","_","_"],
  // 9: 鼻
  ["_","_","S","S","S","S","S","s","s","S","S","s","s","S","S","S","S","S","_","_"],
  // 10: 口（表情差し替え行）
  ["_","_","S","S","S","S","S","S","E","E","E","E","S","S","S","S","S","S","_","_"],
  // 11: 顎
  ["_","_","_","S","S","S","S","S","S","S","S","S","S","S","S","S","S","_","_","_"],
  // 12: 首
  ["_","_","_","_","S","S","S","S","S","S","S","S","S","S","S","_","_","_","_","_"],
  // 13: 首
  ["_","_","_","_","_","S","S","S","S","S","S","S","S","S","_","_","_","_","_","_"],
  // 14: 肩・白衣
  ["_","_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_","_"],
  // 15: 肩幅広く
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 16: 胸
  ["_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_"],
  // 17: 胸ポケット
  ["_","W","W","W","w","W","W","W","W","W","W","W","W","W","W","w","W","W","W","_"],
  // 18: 胸
  ["_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_"],
  // 19: 腹
  ["_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_"],
  // 20: 腹
  ["_","W","w","W","W","W","W","W","W","W","W","W","W","W","W","W","W","w","W","_"],
  // 21: 腹下
  ["_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_"],
  // 22: 腰
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 23: 足上
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 24: 足
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 25: 足
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 26: 足下
  ["_","_","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","_","_"],
  // 27: 靴
  ["_","_","_","E","E","E","E","E","_","_","_","_","E","E","E","E","E","_","_","_"],
  // 28: 靴底
  ["_","_","_","E","E","E","E","E","_","_","_","_","E","E","E","E","E","_","_","_"],
  // 29: 空白
  ["_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_"],
  // 30: 空白
  ["_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_"],
  // 31: 空白
  ["_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_","_"],
];

// ─── 表情差し替え行の定義 ─────────────────────────────────────
// 行6（眉）・行7（目）・行10（口）を差し替える

type ExpressionOverrides = {
  row6: ColorKey[];  // 眉
  row7: ColorKey[];  // 目
  row10: ColorKey[]; // 口
  cheekL?: ColorKey; // 頬左 (row9, col4)
  cheekR?: ColorKey; // 頬右 (row9, col15)
};

const EXPRESSIONS: Record<SpriteExpression, ExpressionOverrides> = {
  // 通常: 眉まっすぐ・目まっすぐ・口直線
  normal: {
    row6: ["_","_","S","S","E","E","S","S","S","S","S","S","S","S","E","E","S","S","_","_"],
    row7: ["_","_","S","S","E","E","S","S","S","S","S","S","S","S","E","E","S","S","_","_"],
    row10:["_","_","S","S","S","S","S","S","E","E","E","E","S","S","S","S","S","S","_","_"],
  },
  // 不満: 眉内側下がる・目細い・口への字
  annoyed: {
    row6: ["_","_","S","E","E","S","S","S","S","S","S","S","S","S","E","E","S","S","_","_"],
    row7: ["_","_","S","S","E","E","S","S","S","S","S","S","S","E","E","S","S","S","_","_"],
    row10:["_","_","S","S","S","S","S","E","E","E","E","E","S","S","S","S","S","S","_","_"],
  },
  // 怒り: 眉への字・目細くとがる・口への字強め
  angry: {
    row6: ["_","_","S","E","E","S","S","S","S","S","S","S","S","S","E","E","E","S","_","_"],
    row7: ["_","_","S","S","E","E","E","S","S","S","S","S","E","E","E","S","S","S","_","_"],
    row10:["_","_","S","S","S","S","E","E","E","S","S","E","E","E","S","S","S","S","_","_"],
    cheekL: "r",
    cheekR: "r",
  },
  // 激怒: 眉Ｖ字・目見開き・口開く・頬赤
  furious: {
    row6: ["_","_","E","E","S","S","S","S","S","S","S","S","S","S","S","S","E","E","_","_"],
    row7: ["_","_","S","E","E","E","S","S","S","S","S","S","S","S","E","E","E","S","_","_"],
    row10:["_","_","S","S","S","E","E","S","S","S","S","S","S","E","E","S","S","S","_","_"],
    cheekL: "R",
    cheekR: "R",
  },
  // 満足: 眉なだらか・目和らぐ・口微笑
  satisfied: {
    row6: ["_","_","S","S","S","E","E","S","S","S","S","S","S","E","E","S","S","S","_","_"],
    row7: ["_","_","S","S","S","E","E","S","S","S","S","S","S","E","E","S","S","S","_","_"],
    row10:["_","_","S","S","S","S","S","S","E","S","S","E","S","S","S","S","S","S","_","_"],
  },
};

// ─── グリッドに表情を合成 ─────────────────────────────────────
function applyExpression(
  base: ColorKey[][],
  expr: SpriteExpression
): ColorKey[][] {
  const ov = EXPRESSIONS[expr];
  const grid = base.map((row) => [...row]);
  grid[6]  = [...ov.row6];
  grid[7]  = [...ov.row7];
  grid[10] = [...ov.row10];
  if (ov.cheekL) { grid[9][4]  = ov.cheekL; grid[9][5]  = ov.cheekL; }
  if (ov.cheekR) { grid[9][14] = ov.cheekR; grid[9][15] = ov.cheekR; }
  return grid;
}

// ─── コンポーネント ───────────────────────────────────────────
interface NakanoSpriteProps {
  expression: SpriteExpression;
  className?: string;
}

export default function NakanoSprite({
  expression,
  className = "",
}: NakanoSpriteProps) {
  const grid = applyExpression(BASE_ROWS, expression);

  return (
    <svg
      width={COLS * PIXEL}
      height={ROWS * PIXEL}
      viewBox={`0 0 ${COLS * PIXEL} ${ROWS * PIXEL}`}
      className={className}
      style={{ imageRendering: "pixelated" }}
      aria-label={`仲野スプライト: ${expression}`}
    >
      {renderGrid(grid)}
    </svg>
  );
}
